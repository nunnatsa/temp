# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  workflow_dispatch:

jobs:
  collect-info:
    name: Prepare some data to consume later
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the latest code
        id: create-date-info
        run: |
          BUILD_DATE_TIME=$(date +%Y-%m-%dT%H:%M:%S)
          echo "build_date_time=${BUILD_DATE_TIME}" >> "$GITHUB_OUTPUT"
          echo "Generated build BUILD_DATE_TIME: ${BUILD_DATE_TIME}"
      - name: Get git ref
        id: get-git-ref
        run: |
          GIT_REF=${{ github.ref }}
          if [[ "${GIT_REF}" == "refs/heads/main" ]]; then
            GIT_REF="main"
          else
            GIT_REF=$(echo "${GIT_REF}" | sed 's|refs/heads/||')
          fi
          echo "git_ref=${GIT_REF}" >> "$GITHUB_OUTPUT"
          echo "Generated git ref: ${GIT_REF}"
    outputs:
      # Define job outputs. The 'new_version' job output will take the value
      # of the 'version' step output from the 'generate-version' step.
      build_date_time: ${{ steps.create-date-info.outputs.build_date_time }}
      git_ref: ${{ steps.get-git-ref.outputs.git_ref }}
  
  use-info:
    name: Use the data generated in the previous step
    runs-on: ubuntu-latest
    needs: collect-info
    steps:
      - name: Get the data from previous step
        run: |
          echo "Collecting data from previous step..."
          echo ${{ needs.collect-info.outputs.build_date_time }}
          echo ${{ needs.collect-info.outputs.git_ref }}
          echo "BUILD_DATE_TIME=${{ needs.collect-info.outputs.build_date_time }}" >> $GITHUB_ENV
          echo "GIT_REF=${{ needs.collect-info.outputs.git_ref }}" >> $GITHUB_ENV
      - name: Print the data
        run: |
          echo "BUILD_DATE_TIME: ${{ env.BUILD_DATE_TIME }}"
          echo "GIT_REF: ${{ env.GIT_REF" }}
